# Reproducer

``` bash
module load LUMI/25.03 partition/common EasyBuild-user
unset EBROOTEASYBUILD
eb -f EasyBuild-5.2.0.eb
module load LUMI/25.03 partition/L EasyBuild-user EasyBuild/5.2.0
# Fails:
eb -f expat-2.6.4-cpeGNU-25.03.eb
# Shows why it fails: EBROOT variables are only set for direct external
# dependencies of a package and not for EXTERNAL modules that come in
# via, e.g., the toolchain:
eb -f expat-2.6.4-cpeGNU-25.03-test-EB52.eb
```


# Analysis of the problems with the Cray toolchains in EB 5.2

-   The Cray toolchain modules (in the case of LUMI our owns developed from an alternative
    set of Cray toolchains that CSCS developed for Eiger) load a number of external
    modules.

-   Not all of these modules currently have an entry in the external modules metadata
    file, and for some of them it may not even be trivial to find an environment variable
    that makes sense to map upon an EBROOT environment variable.

    But this doesn't even matter in this story at the moment as for external modules
    that only come in via another module, it looks like the EBROOT environment variable 
    isn't even generated from the metadata.

    This assumption was tested by explicitly adding a module as a build dependency after
    which a matching EBROOT environment variable was being set. 

-   There is now a check however at the end of the prepare step that goes looking for
    EBROOT environment variables for some loaded modules and of course these don't exist
    for external modules that were not explicitly loaded through dependencies of the 
    current EasyConfig but came in via the toolchain module.

    The tricky thing is that some of those external modules are essential and seem to 
    be tested while others are not, and so far I fail to see how the required modules
    are determined.

-   That being said, I will have to take a closer look at how the whole external modules
    stuff works internally but I am not familiar enough with the EasyBuild code. It looks
    like some of these are automatically set even without matching entry in the metadata
    file, but so far I can't find where this would be done.

-   And the strange thing is that even though `eb -x` suggests that not all external modules
    get a matching EBROOT environment variable, the warnings about EBROOT environment variables
    that show up even in `eb -x` disappear and also running the EasyConfig works when I add the
    modules that the toolchain module loads explicitly as build dependencies.

    Of course we would prefer not having to do that, but this was just to analyse the cause 
    of the issue.

-   I am also not sure what will happen on systems where some modules are loaded by default
    that are not generated by EasyBuild. Could they also cause issues in the piece of code 
    that checks for EBROOT environment variables? Obviously if these are written by the sysadmins
    and if the sysadmins also explicitly support EasyBuild, they could put in EBROOT environment
    variables in those modules, but if the system itself does not use EasyBuild but a user wants 
    to use EasyBuild, could they also run into trouble?

-   Some solutions I see without knowing the internals of EasyBuild very well:

    -   An exclusion list for modules that should not be tested could be a solution, but this
        is not a very elegant one. It might be the easiest to implement though.

    -   I don't know how EasyBuild determines for which modules it needs an EBROOT environment
        variable, but that mechanism should be used first to look for external modules and 
        set the correct EBROOT variables for those that are known.

    -   Or after loading the modules, check for which modules there is no EBROOT variable,
        then check if there is metadata available that enables generating that variable,
        and do so. 
    
    Then there is still the issue that I discovered that some seem to be set automatically by
    some piece of code in EasyBuild without entry in the metadata file, so that operation would
    also have to be moved. I may have overlooked something in my setup though.

    The lsecond and third approach above is of course more powerful as there would then be decent EBROOT environment
    variables for those modules in case they would be important later on. Though I currently have
    no such case on LUMI. (Maybe also because if we already have such cases, we simply specify the
    necessary configure or CMake arguments using the environment variables set by the Cray modules).

-   If some of these are indeed set internally, it looks like some bugs entered that code also
    through the history as some versions are not correctly detected but others are.

    E.g., it looks like the `craype` is automatically detected and with the correct version. 
    `cray-mpich` and `cray-dsmml` get reasonable values for their EBROOT environment variables
    but not for their EBVERSION environment variables and instead puts the name of the environment
    variable that has the version as a string.

The EasyConfig that I experimented with. Without the build dependencies, the modules that are
in the build dependencies are loaded via the `cpeGNU/25.03` module, but then the system
complains that it cannot find the software root for craype (as that seems to be the one that
is checked first). With the build dependencies and a corrected metadata file, everything works,
but of course this is an awkward way to work around the issue. Injecting those build dependencies
via a parse hook is also not exactly what one would intend, and it would be complicated code also
as it needs to recognize all toolchains in their various configurations for different partitions
of LUMI.

``` python
easyblock = 'ConfigureMake'

local_expat_version =        '2.6.4'         # https://github.com/libexpat/libexpat/releases

name =    'expat'
version = local_expat_version
versionsuffix = '-test-EB52'

homepage = 'https://libexpat.github.io/'

whatis = [
    'Description: Stream-oriented XML parser library',
    'This module contains the tool xmlwf and static and shared libraries',
]

description = """
Expat is an XML parser library written in C. It is a stream-oriented parser in
which an application registers handlers for things the parser might find in the
XML document (like start tags).

The module contains the command line tool xmlwf and static and shared libraries.
"""

usage = """
The command line utility xmlwf checks whether a XML document is well-formed.
Help for this command is available through a man page.

The library is documented on the expat web page.
"""

docurls = [
    'Web-based documentation: https://libexpat.github.io/doc/',
    'Man page for xmlwf',
]

software_license_urls = [
   'https://github.com/libexpat/libexpat/blob/R_%s/COPYING' % '_'.join(version.split('.')),    
]

toolchain = {'name': 'cpeGNU', 'version': '25.03'}
toolchainopts = {'pic': True}

source_urls = ['https://github.com/libexpat/libexpat/releases/download/R_%s/' % version.replace('.', '_')]
sources =     [SOURCE_TAR_BZ2]
checksums =   ['8dc480b796163d4436e6f1352e71800a774f73dbae213f1860b60607d2a83ada']

# This build dependency is a convention on LUMI that we always add. The module contains a number
# of tools used during builds and mostly statically linked except for some system libraries such
# as libc. It provides a consistent build environment also across system updates.
# Disabled here as it is not essential to show the issue.
#builddependencies = [ # Create a reproducible build environment.
#    ('buildtools', '%(toolchain_version)s', '', True),
#]
# 
# These build dependencies (probably not all of them) were needed to ensure the toolchain
# works. These are modules that are actually loaded by the cpeGNU module.
# 
builddependencies = [
    ('gcc-native/14.2',                EXTERNAL_MODULE),
    #('PrgEnv-gnu/8.6.0',               EXTERNAL_MODULE), # Appears not essential...
    ('craype/2.7.34',                  EXTERNAL_MODULE),
    ('cray-mpich/8.1.32',              EXTERNAL_MODULE),
    ('cray-libsci/25.03.0',            EXTERNAL_MODULE),
    ('cray-dsmml/0.3.1',               EXTERNAL_MODULE),
    #('xpmem/2.11.5-1.3_g73ade43320bc', EXTERNAL_MODULE), # Appears not essential
    #('perftools-base/25.03.0',         EXTERNAL_MODULE), # Appears not essential
]

# Doesn't need MPI, ROCm or BLAS, and module unload never fails so this is safe.
preconfigopts = 'module unload cray-libsci cray-mpich rocm xpmem && '
prebuildopts = preconfigopts

# Since expat 2.2.6, docbook2X is needed to produce manpage of xmlwf.
# Docbook2X needs XML-Parser and XML-Parser needs expat.
# -> circular dependency. "--without-docbook" breaks this circle.
configopts = ['--without-docbook']

postinstallcmds = [
    'mkdir -p %(installdir)s/share/licenses/%(name)s',
    'cp AUTHORS COPYING README.md %(installdir)s/share/licenses/%(name)s',   
]

sanity_check_paths = {
    'files': ['bin/xmlwf', 'include/expat.h', 'lib/libexpat.a', 'lib/libexpat.%s' % SHLIB_EXT,
              'share/licenses/%(name)s/COPYING'],
    'dirs':  [],
}

sanity_check_commands = [
    'xmlwf -h',
    'pkg-config --libs %(namelower)s',
]

moduleclass = 'tools'
```
